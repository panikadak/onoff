function e(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}let s=new Set,i=new Set,z=new Set(["w","a","s","d"," ","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"]),N=()=>s.has("w")||s.has("ArrowUp")||i.has(0)||i.has(12),h=()=>s.has("a")||s.has("ArrowLeft")||i.has(14),n=()=>s.has("d")||s.has("ArrowRight")||i.has(15),o=(document.addEventListener("keydown",t=>{s.add(t.key),z.has(t.key)&&t.preventDefault()}),document.addEventListener("keyup",({key:t})=>{s.delete(t)}),new Map);requestAnimationFrame(function t(e){var s=navigator.getGamepads()[0];s?(s.buttons.forEach((t,e)=>{t.pressed?(i.has(e)||(t=o.get(e))&&t.forEach(t=>t()),i.add(e)):i.delete(e)}),requestAnimationFrame(t)):i.clear()});var r=[[[24,239],[724,244],[[0,288,330,192,1],[438,288,330,192,1]],[]],[[371,51],[724,404],[[0,100,768,16,1],[0,216,768,16,0],[0,332,768,16,1],[0,448,768,32,0]],[]],[[24,239],[724,244],[[0,288,330,192,1],[438,288,330,192,0]],[]],[[23,263],[724,268],[[0,312,768,8,1],[380,0,8,312,1],[0,408,768,72,0]],[]],[[116,96],[628,412],[[64,448,128,32,!1],[320,448,128,32,!0],[576,448,128,32,!1]],[]],[[24,399],[604,152],[[0,448,768,32,1],[128,320,512,8,1],[632,328,8,120,1],[128,192,512,8,1],[128,200,8,120,1],[640,384,128,8,0],[0,256,128,8,0]],[]],[[16,275],[566,248],[[0,0,768,64,1],[0,64,128,192,1],[0,324,248,92,1],[0,416,768,64,1],[192,132,180,96,1],[440,64,100,224,1],[620,112,72,245,1],[192,228,56,96,1],[300,288,320,69,1]],[]],[[16,367],[704,84],[[0,416,244,64,1],[524,128,244,352,1],[288,320,64,160,0],[416,224,64,256,0]],[]],[[104,175],[176,32],[[96,224,56,8,1],[96,232,56,8,0],[144,72,8,152,1],[152,72,8,168,0],[160,72,128,92,1],[160,164,256,92,1],[160,256,384,92,1],[544,256,8,92,0],[160,348,512,92,1],[160,440,512,8,0],[552,340,120,8,0]],[]],[[16,422],[724,416],[[0,472,48,8,1],[0,376,48,8,0],[0,280,48,8,1],[0,184,96,8,0],[384,456,384,24,1]],[]],[[16,239],[724,244],[[0,288,768,192,1],[336,0,96,288,1]],[]],[[16,56],[724,216],[0,1,2,3,4,5,6,7].map(t=>[96*t,e(240,300),e(24,72),e(24,180),e(0,2)]),[]],[[48,383],[696,384],[[48,432,24,24,1],[156,348,24,24,0],[48,264,24,24,1],[156,180,24,24,0],[264,180,24,24,1],[372,180,24,24,0],[480,180,24,24,1],[588,180,24,24,0],[696,264,24,24,1],[588,348,24,24,0],[696,432,24,24,1]],[]],[[24,8],[724,e(128,416)],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23].map(t=>[32*t,e(64,464),8,8,e(0,2)]),[]],[[372,391],[372,20],[[320,440,128,8,1],[320,344,128,8,0],[320,248,128,8,1],[320,152,128,8,0]],[[320,448,128,8,1,"down"],[320,352,128,8,0,"down"],[320,256,128,8,1,"down"],[320,160,128,8,0,"down"]]],[[372,15],[372,418],[[320,64,128,16,1],[256,80,256,128,0],[320,208,128,16,1],[348,224,72,160,1],[348,384,8,96,1],[356,384,8,96,0],[412,384,8,96,1],[404,384,8,96,0]],[[312,64,8,16,1,"left"],[448,64,8,16,1,"right"],[312,208,8,16,1,"left"],[448,208,8,16,1,"right"]]],[[24,64],[724,e(128,416)],[[0,e(128,352),768,2,!0]],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(t=>[48*t,e(128,352),16,8,e(0,2),"up"])],[[371,20],[372,372],[[336,320,96,8,!0],[336,416,96,8,!0],[336,328,8,88,!0],[424,328,8,88,!0]],[[336,312,96,8,!0,"up"]]],[[371,20],[584,404],[[0,152,368,8,!0],[0,248,448,8,!0],[0,344,528,8,!0]],[[0,144,368,8,!0,"up"],[0,240,448,8,!0,"up"],[0,336,528,8,!0,"up"]]],[[12,312],[725,307],[[0,152,768,72,!0],[0,362,64,8,!0],[192,362,128,8,!0],[448,362,128,8,!0],[704,362,64,8,!0]],[[0,224,768,8,!0,"down"]]],[[371,20],[372,404],[[320,384,128,8,!0],[320,272,128,8,!1],[320,168,128,8,!0]],[[320,376,128,8,!0,"up"],[320,264,128,8,!1,"up"],[320,160,128,8,!0,"up"]]],[[63,263],[660,272],[[48,312,96,96,1],[144,124,48,284,1],[192,124,96,96,1],[192,312,96,96,0],[288,124,48,284,1],[336,312,96,96,1],[432,124,48,284,1],[480,124,96,96,1],[480,312,96,96,0],[576,124,48,284,1],[624,312,96,96,1]],[[232,304,16,8,0,"up"],[520,304,16,8,0,"up"]]],[[148,254],[600,266],[[94,176,8,128,!0],[222,176,8,128,!0],[94,168,136,8,!0],[94,304,136,8,!0],[318,176,8,128,!0],[446,176,8,128,!0],[318,168,136,8,!0],[318,304,136,8,!0],[542,176,8,128,!0],[670,176,8,128,!0],[542,168,136,8,!0],[542,304,136,8,!0]],[]],[[400,20],[372,432],[],[[0,96,384,8,!0,"up"],[0,104,384,8,!1,"down"],[400,240,368,8,!0,"up"],[400,248,368,8,!1,"down"],[0,384,384,8,!0,"up"],[0,392,384,8,!1,"down"]]],[[368,14],[269,419],[],[[328,32,8,80,1,"right"],[320,32,8,80,0,"left"],[424,32,8,80,1,"left"],[432,32,8,80,0,"right"],[280,175,8,80,1,"right"],[272,174,8,80,0,"left"],[376,175,8,80,1,"left"],[384,175,8,80,0,"right"],[232,320,8,80,1,"right"],[224,319,8,80,0,"left"],[328,320,8,80,1,"left"],[336,319,8,80,0,"right"]]]],a=h=>new Promise((s,t)=>{let i=performance.now();requestAnimationFrame(function t(e){if(e>=i+h)return s();requestAnimationFrame(t)})});class d{constructor(t){this.element=t,this.bounds={}}get hidden(){return this.element.hasAttribute("hidden")}set hidden(t){t?this.element.setAttribute("hidden",""):this.element.removeAttribute("hidden")}get x(){return this._x}set x(t){this._x=t||0,this.element.setAttribute("x",Math.round(this.x))}get y(){return this._y}set y(t){this._y=t||0,this.element.setAttribute("y",Math.round(this.y))}get width(){return this._width}set width(t){this._width=Math.max(0,t||0),this.element.setAttribute("width",Math.round(this.width))}get height(){return this._height}set height(t){this._height=Math.max(0,t||0),this.element.setAttribute("height",Math.round(this.height))}get top(){return this.y}get bottom(){return this.y+this.height}set bottom(t){this.y=(t||0)-this.height}get left(){return this.x}get right(){return this.x+this.width}set right(t){this.x=(t||0)-this.width}set bottom(t){this.y=t-this.height}isLeftOf(t){return this.right<=t.left}isRightOf(t){return this.left>=t.right}isAbove(t){return this.bottom<=t.top}isBelow(t){return this.top>=t.bottom}overlaps(t){return this.left<t.right&&this.right>t.left&&this.top<t.bottom&&this.bottom>t.top}append({element:t}){this.element.appendChild(t)}remove(){this.element.remove()}}var c=t=>document.createElementNS("http://www.w3.org/2000/svg",t);class U extends d{constructor(t,e){super(c("svg")),this.element.innerHTML=`
    <svg id="goal"><g id="inner-goal"><g id="inner-goal-finish">
      <path d="M12 19.26L6.37 22.1a1 1 0 0 1-1.44-1.07l1.05-5.98-4.47-4.22a1 1 0 0 1 .55-1.72l6.22-.88 2.83-5.5a1 1 0 0 1 1.78 0l2.83 5.5 6.22.88a1 1 0 0 1 .55 1.72l-4.47 4.22 1.05 5.98a1 1 0 0 1-1.44 1.07L12 19.26z"/>
    </g></g></svg>`,this.width=22,this.height=20,this.load(t,e)}load(t,e){this.x=t,this.y=e}toJSON(){return[Math.round(this.x),Math.round(this.y)]}}class I extends d{constructor(t,e){super(c("svg")),this.element.innerHTML=`
    <svg id="guy">
      <g id="inner-guy">
        <rect class="accent" x="0" y="17" width="24" height="21"/>
        <rect id="left_foot" class="accent" x="4" y="38" width="6" height="10"/>
        <rect id="right_foot" class="accent" x="14" y="38" width="6" height="10"/>
        <g id="head">
          <rect class="accent" x="0" y="0" width="26" height="19"/>
          <rect id="face" x="4" y="3" width="20" height="14"/>
          <rect class="accent" x="9" y="7" width="4" height="4"/>
          <rect class="accent" x="17" y="7" width="4" height="4"/>
        </g>
      </g>
    </svg>`,this.load(t,e),this.height=48,this.width=26,this.speed=360,this.vx=0,this.vy=0}tick(t){h()&&!n()?(this.vx=-t(this.speed),this.faceLeft=!0):n()&&!h()?(this.vx=t(this.speed),this.faceLeft=!1):this.vx=0,this.walking=h()||n()}get faceLeft(){return!!this._faceLeft}set faceLeft(t){this._faceLeft=!!t,this.element.classList.toggle("left",this.faceLeft)}get walking(){return!!this._walking}set walking(t){this._walking=!!t,this.element.classList.toggle("walk",this.walking)}load(t,e){this.x=t,this.y=e}toJSON(){return[Math.round(this.x),Math.round(this.y)]}}class T extends d{constructor(t,e,s,i,h){super(c("rect")),this.width=s,this.height=i,this.x=t,this.y=e,this.on=h}get on(){return!!this._on}set on(t){this._on=!!t,this.element.classList.toggle("light",this.on),this.element.classList.toggle("dark",!this.on)}toJSON(){return[Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height),Number(this.on)]}}let O=[0,1];class J extends d{constructor(t){super(document.getElementById("title")),this.game=t,this.items=[].slice.call(this.element.querySelectorAll(".menu .item")),this.selected=0}keydown({key:t}){switch(t){case"ArrowUp":--this.selected;break;case"ArrowDown":this.selected+=1;break;case"Enter":this.choose()}}choose(){switch(this.selected){case 0:this.game.scene.index=0,this.game.scene.paused=!1,this.game.state="play";break;case 1:this.game.state="controls"}}get selected(){return this._selected}set selected(t){this._selected=Math.min(O.length-1,Math.max(0,t||0)),this.items.forEach((t,e)=>{t.classList.toggle("selected",e===this.selected)})}}var P=440*Math.pow(Math.pow(2,1/12),-9),W=/^[0-9.]+$/,$=/\s+/,H=/(\d+)/,V={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(t,e){t.split("-").forEach(function(t){V[t]=e})});function l(t){t=t.split($),this.frequency=l.getFrequency(t[0])||0,this.duration=l.getDuration(t[1])||0}l.getFrequency=function(t){var t=t.split(H),e=V[t[0]],t=(t[1]||4)-4;return P*Math.pow(Math.pow(2,1/12),e)*Math.pow(2,t)},l.getDuration=function(t){return W.test(t)?parseFloat(t):t.toLowerCase().split("").reduce(function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)},0)};function t(t,e,s){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,s||[])}t.prototype.createFxNodes=function(){var s=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(t,e){(e=this[t[0]]=this.ac.createBiquadFilter()).type="peaking",e.frequency.value=t[1],s.connect(s=e)}.bind(this)),s.connect(this.ac.destination),this},t.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof l?t:new l(t))}.bind(this)),this},t.prototype.createCustomWave=function(t,e){e=e||t,this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},t.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},t.prototype.scheduleNote=function(t,e){var s=60/this.tempo*this.notes[t].duration,i=s*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,i),this.setFrequency(0,e+i),e+s},t.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},t.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},t.prototype.slide=function(t,e,s){var i=this.getNextNote(t),h=this.getSlideStartDelay(s);return this.setFrequency(this.notes[t].frequency,e+h),this.rampFrequency(i.frequency,e+s),this},t.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},t.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},t.prototype.play=function(s){return s="number"==typeof s?s:this.ac.currentTime,this.createOscillator(),this.osc.start(s),this.notes.forEach(function(t,e){s=this.scheduleNote(e,s)}.bind(this)),this.osc.stop(s),this.osc.onended=this.loop?this.play.bind(this,s):null,this},t.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this};var u=new AudioContext;let g=new t(u,100,["B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","Bb3 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","B2 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","Bb3 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","B2 q","- 32"]),m=new t(u,100,["- w","- h","D3 q","Db3 q","- w","- h","D3 q","Gb3 q","- w","- h","D3 q","Db3 q","- w","- h","D3 q","Gb3 q","- 32"]),p=new t(u,100,["B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","- e","Db4 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","Db4 e","B3 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","- e","Db4 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","Db4 e","B3 e","- e","- 32"]),w=new t(u,100,["- 32","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","Gb3 e","G3 e","Gb3 e","Bb2 e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","D3 e","Db3 e","B2 e","- e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","Gb3 e","G3 e","Gb3 e","Bb2 e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","D3 e","Db3 e","B2 e","- e"]),y=new t(u,100,["- 32","G4 w","Gb4 w","G4 w","Gb4 w","G4 w","Gb4 w","G4 w","Gb4 w"]),b=new t(u,100,["- 32","C4 w","D4 w","C4 w","D4 w","C4 w","D4 w","C4 w","D4 w"]),v=new t(u,200,["C3 q","- q","G3 q","- q","C3 q","- q","G3 q","G2 q","C3 q","- q","G3 q","- q","B2 q","- q","B2 q","A2 q","G2 q","- h","- q","E3 q","- h","- q","G2 q","- w","- h","B2 q"]),f=new t(u,200,["G4 e","Gb4 e","G4 e","Gb4 e","G4 q","A4 q","G4 h","C4 q","E4 q","G4 e","Gb4 e","G4 e","Gb4 e","G4 q","E4 q","F4 h","D4 q","E4 q","F4 e","E4 e","F4 e","E4 e","F4 q","G4 q","E4 e","D4 e","E4 e","D4 e","E4 q","F4 q","G3 e","A3 e","B3 e","C4 e","D4 e","E4 e","F4 e","E4 e","D4 e","C4 e","B3 e","A3 e","G3 q","E4 q"]),x=(v.staccato=.3,f.staccato=.5,v.waveType="sine",v.gain.gain.value=.7,f.gain.gain.value=.3,g.staccato=.5,w.staccato=.3,m.staccato=.5,p.staccato=.5,g.waveType="sine",w.waveType="sine",m.waveType="sine",g.gain.gain.value=.4,w.gain.gain.value=.6,m.gain.gain.value=.4,p.gain.gain.value=.4,1),q="up",k=(setInterval(function(){"up"===q&&9<(x+=1)&&(q="down",--x),"down"===q&&--x<1&&(q="up",x+=2),y.gain.gain.value=.01*x,b.gain.gain.value=.01*x},300),()=>{g.play(),m.play(),p.play(),w.play(),y.play(),b.play(),v.stop(),f.stop()}),B=(k(),new t(u,320,["Bb3 e","G5 e","Bb4 e"])),A=new t(u,400,["Bb6 e","D6 e"]),E=new t(u,400,["D6 e","Bb6 e"]),D=new t(u,280,["C4 s","G4 s","C5 h"]),G=new t(u,280,["Bb3 e","Bb2 q"]);B.loop=!1,D.loop=!1,G.loop=!1,A.loop=!1,E.loop=!1,B.smoothing=1,G.smoothing=.5,D.staccato=.2,A.staccato=.5,E.staccato=.5,G.waveType="sawtooth",G.bass.gain.value=10,B.gain.gain.value=.3,D.gain.gain.value=.6,G.gain.gain.value=.4,A.gain.gain.value=.3,E.gain.gain.value=.3;class K extends d{constructor(t){super(t),this.value=0}get value(){return this._value}set value(t){this._value=t||0,this.element.innerHTML="";let e=0;for(var s of this.value.toString()){var i=new d(c("rect"));i.element.setAttribute("fill",`url(#n${s})`),i.width=10,i.height=16,i.x=12*e++,this.append(i)}}}class j extends d{constructor(t,e,s,i,h,n){super(c("svg")),this.rect=c("rect"),this.rect.setAttribute("x","0"),this.rect.setAttribute("y","0"),this.rect.setAttribute("width","100%"),this.rect.setAttribute("height","100%"),this.element.appendChild(this.rect),this.width=s,this.height=i,this.x=t,this.y=e,this.on=h,this.direction=n}get isUp(){return"up"===this.direction}get isDown(){return"down"===this.direction}get isLeft(){return"left"===this.direction}get isRight(){return"right"===this.direction}get width(){return super.width}set width(t){super.width=t,(this.isUp||this.isDown)&&this.element.setAttribute("width",16*Math.round(this.width/16))}get height(){return super.height}set height(t){super.height=t,(this.isLeft||this.isRight)&&this.element.setAttribute("height",16*Math.round(this.height/16))}get on(){return!!this._on}set on(t){this._on=!!t,this.element.classList.toggle("light",this.on),this.element.classList.toggle("dark",!this.on)}get direction(){return this._direction}set direction(t){this._direction=t,this.rect.setAttribute("fill",`url(#spike-${this.direction})`)}toJSON(){return[Math.round(this.x),Math.round(this.y),this.isUp||this.isDown?16*Math.round(this.width/16):this.width,this.isLeft||this.isRight?16*Math.round(this.height/16):this.height,Number(this.on),this.direction]}}class L extends d{constructor(t,e){super(document.getElementById(t)),this.pressed=e}tick(){this.element.classList.toggle("dark",!this.pressed()),this.element.classList.toggle("light",this.pressed())}}class X extends d{constructor(t){super(document.getElementById("controls")),this.game=t,this.keys=[new L("key-w",()=>s.has("w")),new L("key-a",()=>s.has("a")),new L("key-d",()=>s.has("d")),new L("key-space",()=>s.has(" ")),new L("button-toggle",()=>i.has(1)),new L("button-jump",()=>i.has(0)),new L("button-left",()=>i.has(14)),new L("button-right",()=>i.has(15))]}keydown({key:t}){switch(t){case"Enter":this.game.state="title";break;case"ArrowUp":case"ArrowDown":this.element.querySelector(".menu .item").classList.add("selected")}}tick(){if(!this.hidden)for(var t of this.keys)t.tick()}}let Y=document.getElementById("editor"),M=Y.createSVGPoint(),_=({clientX:t,clientY:e})=>(M.x=t,M.y=e,M.matrixTransform(Y.getScreenCTM().inverse())),C=null,F=null;document.addEventListener("mouseup",()=>{C=F=null}),document.addEventListener("mousedown",t=>{0===t.button&&(F=_(t))}),document.addEventListener("mousemove",t=>{var e;C&&({x:t,y:e}=_(t),C({x:t-F.x,y:e-F.y}),F={x:t,y:e})}),document.getElementById("close-dialog").addEventListener("click",()=>{document.getElementById("dialog").hidden=!0});class Q extends T{constructor(...t){super(...t),this.element.addEventListener("dblclick",this.dblclick.bind(this)),this.element.addEventListener("mousemove",this.mousemove.bind(this)),this.element.addEventListener("mousedown",this.mousedown.bind(this))}dblclick(){this.on=!this.on}mousemove(t){var{x:t,y:e}=_(t);this.element.style.cursor=this.cursor(this.region(t,e))}mousedown(t){var e;0===t.button&&({x:t,y:e}=_(t),C=this.resize.bind(this,this.region(t,e)))}resize(t,{x:e,y:s}){switch(t){case"m":this.x+=e,this.y+=s;break;case"n":this.y+=s,this.height-=s;break;case"s":this.height+=s;break;case"e":this.width+=e;break;case"w":this.x+=e,this.width-=e;break;case"nw":this.resize("n",{x:e,y:s}),this.resize("w",{x:e,y:s});break;case"ne":this.resize("n",{x:e,y:s}),this.resize("e",{x:e,y:s});break;case"sw":this.resize("s",{x:e,y:s}),this.resize("w",{x:e,y:s});break;case"se":this.resize("s",{x:e,y:s}),this.resize("e",{x:e,y:s})}}region(t,e){return t-=this.x,e-=this.y,t<=3?e<=3?"nw":e<this.height-3?"w":"sw":t<this.width-3?e<=3?"n":e<this.height-3?"m":"s":e<=3?"ne":e<this.height-3?"e":"se"}cursor(t){switch(t){case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";case"nw":case"se":return"nwse-resize";case"ne":case"sw":return"nesw-resize";case"m":return"move"}}}class S extends j{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("dblclick",this.dblclick.bind(this)),this.element.addEventListener("mousedown",this.mousedown.bind(this)),this.element.addEventListener("mousemove",this.mousemove.bind(this))}get direction(){return super.direction}set direction(t){super.direction=t,this.rect.setAttribute("fill",`url(#edit-spike-${this.direction})`)}dblclick(){this.on=!this.on}mousemove(t){var{x:t,y:e}=_(t);this.element.style.cursor=this.cursor(this.region(t,e))}mousedown(t){var e;0===t.button&&({x:t,y:e}=_(t),C=this.resize.bind(this,this.region(t,e)))}resize(t,{x:e,y:s}){switch(t){case"n":this.y+=s,this.height-=s;break;case"s":this.height+=s;break;case"e":this.width+=e;break;case"w":this.x+=e,this.width-=e;break;case"m":this.x+=e,this.y+=s}}region(t,e){return t-=this.x,e-=this.y,this.isUp||this.isDown?t<=3?"w":t<this.width-3?"m":"e":e<=3?"n":e<this.height-3?"m":"s"}cursor(t){switch(t){case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";case"m":return"move"}}}class Z extends I{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("mousedown",this.mousedown.bind(this))}mousedown(t){0===t.button&&(C=({x:t,y:e})=>{this.x+=t,this.y+=e})}}class tt extends U{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("mousedown",this.mousedown.bind(this))}mousedown(t){0===t.button&&(C=({x:t,y:e})=>{this.x+=t,this.y+=e})}}class et extends d{constructor(t,e){super(document.getElementById("editor")),this.bars=[],this.spikes=[],this.levels=t,this.game=e,this.guy=new Z,this.append(this.guy),this.goal=new tt,this.append(this.goal),this.level=0,document.addEventListener("keydown",this.keydown.bind(this))}addBar(e){this.bars.push(e),this.append(e),e.element.addEventListener("click",({shiftKey:t})=>{t&&(e.remove(),this.bars=this.bars.filter(t=>t===e))})}addSpike(e){this.spikes.push(e),this.append(e),e.element.addEventListener("click",({shiftKey:t})=>{t&&(e.remove(),this.spikes=this.spikes.filter(t=>t===e))})}get level(){return this._level}set level(t){this._level=Math.max(0,Math.min(this.levels.length-1,t));var e,s,[t,i,h,n]=this.levels[this.level];for(this.guy.load(...t),this.goal.load(...i);this.bars.length;)this.bars.pop().remove();for(e of h)this.addBar(new Q(...e));for(;this.spikes.length;)this.spikes.pop().remove();for(s of n)this.addSpike(new S(...s))}keydown({key:t}){if(!this.hidden)switch(t){case"ArrowRight":this.level+=1;break;case"ArrowLeft":--this.level;break;case"p":this.addBar(new Q(0,0,48,48,!0));break;case"c":navigator.clipboard.writeText(JSON.stringify(this));break;case"u":case"d":case"l":case"r":s.has("s")&&this.addSpike("u"===t||"d"===t?new S(0,0,64,8,!0,"u"===t?"up":"down"):new S(0,0,8,64,!0,"l"===t?"left":"right"));break;case"h":document.getElementById("dialog").hidden=!document.getElementById("dialog").hidden;break;case"g":var e=new URL(window.location);e.searchParams.set("level",JSON.stringify(this)),window.location=e.toString();break;case"Escape":this.game&&(this.game.state="title")}}toJSON(){return[this.guy,this.goal,this.bars,this.spikes]}}class st extends d{constructor(t,e){super(document.getElementById("game")),this.deaths=new K(document.getElementById("death-counter")),this.stars=new K(document.getElementById("level-counter")),this.congrats=new d(document.getElementById("congrats")),this.esc=new d(document.getElementById("esc")),this.game=t,this.levels=e,this.bars=[],this.spikes=[],this.paused=!1,this.guy=new I,this.append(this.guy),this.goal=new U,this.append(this.goal),this.index=0}get fromURL(){return!!this._fromURL}set fromURL(t){this._fromURL=!!t,this.esc.hidden=!this.fromURL}keydown({key:t}){switch(t){case"Enter":this.finished&&(this.fromURL=!1,this.levels=r,this.game.state="title",k());break;case"Escape":this.fromURL&&(this.fromURL=!1,this.levels=r,this.game.state="title",k())}}get on(){return this._on}set on(t){this._on=t,document.body.classList.toggle("on",t),document.body.classList.toggle("off",!t)}get index(){return this._index}set index(t){for(this._index=Math.min(this.levels.length,Math.max(t||0)),this.on=!0,this.stars.value=this.index;this.bars.length;)this.bars.pop().remove();for(;this.spikes.length;)this.spikes.pop().remove();if(this.finished)this.guy.hidden=!0,this.congrats.hidden=!1,g.stop(),m.stop(),p.stop(),w.stop(),y.stop(),b.stop(),v.play(),f.play();else{var e,s,[t,i,h,n]=this.level;this.guy.load(...t),this.guy.hidden=!1,this.goal.load(...i),this.goal.hidden=!1,this.congrats.hidden=!0;for(e of h){var o=new T(...e);this.append(o),this.bars.push(o)}for(s of n){var r=new j(...s);this.append(r),this.spikes.push(r)}}}get level(){return this.levels[this.index]}get finished(){return this.index>=this.levels.length}async advance(){D.play(),this.paused=!0,document.body.classList.add("finish"),await a(1e3),this.index+=1,document.body.classList.remove("finish"),await a(1e3),this.finished?this.goal.hidden=!0:this.paused=!1}async death(){G.play(),this.deaths.value+=1,this.paused=!0;var t=document.getElementById("death");t.setAttribute("x",this.guy.x-32+this.guy.width/2),t.setAttribute("y",this.guy.y-32+this.guy.height/2),this.guy.element.setAttribute("hidden",!0),document.body.classList.add("dying"),await a(700),document.body.classList.remove("dying"),this.reset(),this.guy.element.removeAttribute("hidden"),this.paused=!1}reset(){this.guy.load(...this.level[0])}lost(){return 480<this.guy.bottom||this.bars.some(t=>t.on===this.on&&t.overlaps(this.guy))||this.spikes.some(t=>t.on===this.on&&t.overlaps(this.guy))}setBounds(t){var e,s=t.bounds;s.left=-t.left,s.right=768-t.right,s.top=-t.top,s.bottom=480-t.bottom+1;for(e of this.bars)e.on===this.on&&(e.top<t.bottom&&e.bottom>t.top&&(e.isRightOf(t)?s.right=Math.min(s.right,e.left-t.right):e.isLeftOf(t)&&(s.left=Math.max(s.left,e.right-t.left))),e.left<t.right)&&e.right>t.left&&(e.isBelow(t)?s.bottom=Math.min(s.bottom,e.top-t.bottom):e.isAbove(t)&&(s.top=Math.max(s.top,e.bottom-t.top)));return s}tick(t){var e,s;this.paused||this.hidden||(this.guy.tick(t),{left:s,right:e}=this.setBounds(this.guy),{top:e,bottom:s}=(this.guy.x+=Math.min(e,Math.max(s,this.guy.vx)),this.setBounds(this.guy)),this.guy.y+=Math.min(s,Math.max(e,this.guy.vy)),0===s?(this.guy.vy=N()?-t(1200):0,N()&&B.play()):this.guy.vy=Math.min(t(600),this.guy.vy+t(120)),this.lost()?this.death():this.guy.overlaps(this.goal)&&this.advance())}}class it{constructor(){var t,e;this.title=new J(this),this.controls=new X(this),this.scene=new st(this,r),this.editor=new et([[[100,300],[500,300],[[84,361,362,48,1]],[[446,401,176,8,1,"up"]]]],this),this.dialog=document.getElementById("dialog"),t=1,e=this.toggle.bind(this),o.has(t)||o.set(t,[]),o.get(t).push(e),document.addEventListener("keydown",this.keydown.bind(this))}toggle(){this.scene.on=!this.scene.on,(this.scene.on?E:A).play()}keydown(t){" "===t.key&&this.toggle(),this.scene.hidden?this.controls.hidden?this.title.hidden||this.title.keydown(t):this.controls.keydown(t):this.scene.keydown(t)}get state(){return this._state}set state(t){this._state=t,this.scene.hidden="play"!==this.state,this.title.hidden="title"!==this.state,this.controls.hidden="controls"!==this.state,this.editor.hidden="edit"!==this.state,this.dialog.hidden="edit"!==this.state}tick(t){this.scene.tick(t),this.controls.tick(t)}}let R=new it;u=new URL(window.location).searchParams.get("level");if(u)try{R.scene.levels=[JSON.parse(u)],R.scene.fromURL=!0,R.scene.index=0,R.state="play"}catch(t){}let ht=0;requestAnimationFrame(function t(e){let s=e-ht;R.tick(t=>Math.round(t*s/1e3)),ht=e,requestAnimationFrame(t)});
